# Two-Factor Authentication (2FA) Testing Guide

## Overview

This guide provides instructions for testing the Two-Factor Authentication implementation in the Cybersecurity Awareness Platform.

## Backend Testing

### 1. Run Database Migration

First, apply the database migration to add 2FA fields:

```bash
cd backend
alembic upgrade head
```

### 2. Install Dependencies

Install the new 2FA dependencies:

```bash
pip install -r requirements.txt
```

### 3. Run Unit Tests

Test the 2FA utilities:

```bash
pytest tests/core/test_two_factor_auth.py -v
```

Test the 2FA API endpoints:

```bash
pytest tests/api/routes/test_two_factor.py -v
```

### 4. Manual API Testing

Start the backend server:

```bash
uvicorn main:app --reload
```

#### Setup 2FA

1. Login to get access token:
```bash
curl -X POST http://localhost:8000/api/auth/login \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "username=user@example.com&password=password123"
```

2. Setup 2FA (requires password confirmation):
```bash
curl -X POST http://localhost:8000/api/auth/2fa/setup \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"password": "password123"}'
```

This returns:
- `secret`: The TOTP secret
- `qr_code`: Base64 encoded QR code image
- `backup_codes`: Array of backup codes
- `manual_entry_key`: Secret for manual entry

3. Scan the QR code with an authenticator app (Google Authenticator, Authy, etc.)

4. Verify the setup with a TOTP code:
```bash
curl -X POST http://localhost:8000/api/auth/2fa/verify \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"totp_code": "123456"}'
```

#### Login with 2FA

1. Try normal login (will return 428 status if 2FA is enabled):
```bash
curl -X POST http://localhost:8000/api/auth/login \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "username=user@example.com&password=password123"
```

2. Login with 2FA code:
```bash
curl -X POST http://localhost:8000/api/auth/login-2fa \
  -H "Content-Type: application/json" \
  -d '{
    "email": "user@example.com",
    "password": "password123",
    "totp_code": "123456"
  }'
```

3. Or login with backup code:
```bash
curl -X POST http://localhost:8000/api/auth/login-backup-code \
  -H "Content-Type: application/json" \
  -d '{
    "email": "user@example.com",
    "password": "password123",
    "backup_code": "ABCD-EFGH"
  }'
```

## Frontend Testing

### 1. Install Dependencies

```bash
cd frontend
npm install
```

### 2. Start Development Server

```bash
npm run dev
```

### 3. Test 2FA Flow

1. **Login Page**: 
   - Navigate to `/login`
   - Enter credentials
   - If 2FA is enabled, you'll be prompted for the code

2. **User Settings**:
   - Navigate to `/settings` (or add route to App.tsx)
   - Go to Security tab
   - Enable 2FA by clicking "Enable Two-Factor Authentication"
   - Follow the setup wizard

3. **2FA Setup Process**:
   - Enter password to confirm
   - Scan QR code or enter manual key
   - Save backup codes
   - Enter verification code to complete setup

4. **2FA Management**:
   - View backup codes status
   - Regenerate backup codes
   - Disable 2FA

## Security Considerations

1. **Encryption**: TOTP secrets are encrypted using Fernet encryption with a key derived from the application's SECRET_KEY

2. **Rate Limiting**: 
   - Setup: 3 attempts per hour
   - Login: 10 attempts per minute
   - 2FA verification: 5 failed attempts per 15 minutes
   - Backup code login: 5 attempts per hour

3. **Backup Codes**:
   - Stored as bcrypt hashes
   - Single-use only
   - 8 codes generated by default

4. **Session Security**:
   - 2FA verification required for each new login
   - No bypass mechanisms

## Troubleshooting

### Common Issues

1. **"Too many failed attempts"**: Wait 15 minutes or check the `two_fa_attempts` table

2. **QR Code not scanning**: Use the manual entry key in your authenticator app

3. **Backup codes not working**: Ensure correct format (XXXX-XXXX) and that the code hasn't been used

4. **Time sync issues**: Ensure server and client times are synchronized (NTP)

## Testing Checklist

- [ ] Database migration successful
- [ ] Unit tests passing
- [ ] Can setup 2FA via API
- [ ] Can login with TOTP code
- [ ] Can login with backup code
- [ ] Rate limiting working
- [ ] Frontend 2FA setup working
- [ ] Frontend 2FA login working
- [ ] Can disable 2FA
- [ ] Can regenerate backup codes
- [ ] Error handling for invalid codes
- [ ] Encryption/decryption working across app restarts